name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.19
      - name: Build the Docker image
        run: |
          make build
          docker build -t telegram-expense-bot:latest .
          docker buildx create --name mybuilder
          docker buildx use mybuilder
          docker buildx inspect --bootstrap
          docker buildx build --platform linux/arm64 -t telegram-expense-bot:arm64 .
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy the Docker image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          script: |
            ssh -i ${{ secrets.SSH_PRIVATE }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} 'bash -s' <<EOF
            docker save telegram-expense-bot:arm64 | ssh -i ${{ secrets.SSH_PRIVATE }} ${{ secrets.SSH_HOST }}@${{ secrets.DEPLOY_HOST }} 'docker load'
            docker stop telegram-expense-bot || true
            docker rm telegram-expense-bot || true
            docker run -d --name telegram-expense-bot -p 8080:8080 telegram-expense-bot:arm64
            EOF
